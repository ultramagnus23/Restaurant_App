generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// --- CORE TRANSACTIONAL DATA ---

model Order {
  id            String      @id @default(cuid()) // Changed to String/CUID for modern standards
  posOrderId    String?     // Nullable because some orders might be manual
  restaurantId  Int
  timestamp     DateTime
  totalAmount   Float
  status        String      @default("completed")
  channel       String      @default("dine_in")
  
  // Relations
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id])
  server        Server?     @relation(fields: [serverId], references: [id])
  serverId      Int?
  orderItems    OrderItem[]
  
  createdAt     DateTime    @default(now())

  @@index([restaurantId, timestamp])
}

model OrderItem {
  id            String      @id @default(cuid())
  orderId       String
  menuItemId    String
  quantity      Int
  priceAtTime   Float
  
  // Relations
  order         Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem      MenuItem    @relation(fields: [menuItemId], references: [id])

  @@index([orderId])
  @@index([menuItemId])
}

model MenuItem {
  id            String      @id @default(cuid())
  restaurantId  Int
  name          String
  category      String?
  currentPrice  Float
  cost          Float?
  isActive      Boolean     @default(true)
  
  // Relations
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id])
  orderItems    OrderItem[]
  baselines     ItemBaseline[]
  decisions     Decision[]

  @@unique([restaurantId, name])
  @@index([restaurantId])
}

model Server {
  id            Int         @id @default(autoincrement())
  restaurantId  Int
  name          String
  externalId    String?
  
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id])
  orders        Order[]

  @@index([restaurantId])
}

model Restaurant {
  id            Int         @id @default(autoincrement())
  name          String
  
  orders        Order[]
  menuItems     MenuItem[]
  servers       Server[]
  
  // Analytics Relations
  aggregates    TimeAggregate[]
  insights      Insight[]
  decisions     Decision[]
  simulations   Simulation[]
  
  createdAt     DateTime    @default(now())
}

// --- ANALYTICS LAYER ---

model TimeAggregate {
  id             String     @id @default(cuid())
  restaurantId   Int
  periodType     String     // 'day', 'week', 'month'
  periodStart    DateTime
  periodEnd      DateTime
  
  totalRevenue   Float
  totalOrders    Int
  avgOrderValue  Float
  
  totalItems     Int
  uniqueItems    Int
  
  hourOfDay      Int?
  dayOfWeek      Int?
  
  computedAt     DateTime   @default(now())
  version        Int        @default(1)
  
  restaurant     Restaurant @relation(fields: [restaurantId], references: [id])

  @@unique([restaurantId, periodType, periodStart, periodEnd, version])
  @@index([restaurantId, periodType, periodStart])
}

model ItemBaseline {
  id               String     @id @default(cuid())
  menuItemId       String
  periodStart      DateTime
  periodEnd        DateTime
  
  avgDailyQuantity Float
  stdDevQuantity   Float
  avgDailyRevenue  Float
  stdDevRevenue    Float
  
  priceElasticity  Float?
  seasonalityIndex Float?
  trendSlope       Float?
  
  sampleSize       Int
  confidenceScore  Float
  
  computedAt       DateTime   @default(now())
  version          Int        @default(1)
  
  menuItem         MenuItem   @relation(fields: [menuItemId], references: [id])

  @@unique([menuItemId, periodEnd, version])
  @@index([menuItemId, periodEnd])
}

// --- DECISION & INSIGHT ENGINE ---

model Insight {
  id              String     @id @default(cuid())
  restaurantId    Int
  type            String     // 'revenue_decomposition', 'item_performance'
  severity        String     // 'critical', 'warning', 'info'
  
  observation     String
  explanation     String
  causalFactors   String?    // JSON
  
  // --- NEW FIELDS REQUIRED BY ENGINE ---
  formula         String?    // Mathematical proof
  assumptions     String?    // JSON array
  sampleSize      Int?       // Statistical sample size
  confidenceScore Float?     // 0-1 score
  
  recommendation  String?
  
  decisionId      String?    @unique
  decision        Decision?  @relation(fields: [decisionId], references: [id])
  
  createdAt       DateTime   @default(now())
  expiresAt       DateTime?  // When this insight becomes stale
  
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId, createdAt])
}

model Decision {
  id             String     @id @default(cuid())
  restaurantId   Int
  type           String     // 'price_change', etc.
  entityType     String     // 'item', 'restaurant'
  entityId       String?    // ID of the entity (MenuItem ID etc)
  
  recommendation String
  rationale      String
  predictedImpact String?   // JSON
  
  status         String     @default("pending") // 'pending', 'accepted'
  implementedAt  DateTime?
  
  menuItem       MenuItem?  @relation(fields: [entityId], references: [id])
  restaurant     Restaurant @relation(fields: [restaurantId], references: [id])
  
  insight        Insight?
  simulation     Simulation? @relation(fields: [simulationId], references: [id])
  simulationId   String?
  
  outcome        DecisionOutcome?
  
  createdAt      DateTime   @default(now())

  @@index([restaurantId, status])
}

model DecisionOutcome {
  id             String     @id @default(cuid())
  decisionId     String     @unique
  actualImpact   String     // JSON
  accuracyScore  Float
  evaluatedAt    DateTime   @default(now())
  
  decision       Decision   @relation(fields: [decisionId], references: [id])
}

model Simulation {
  id             String     @id @default(cuid())
  restaurantId   Int
  type           String
  inputParams    String     // JSON
  projectedMetrics String   // JSON
  
  createdAt      DateTime   @default(now())
  
  restaurant     Restaurant @relation(fields: [restaurantId], references: [id])
  decisions      Decision[]
}
